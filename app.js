/*

I reused this project as an assignment intended to ensure new developers in our company were familiar with web dev. These comments are from that:

Tasks:

* understand this code

* fix the joke button (very easy)

* add emoji button (more difficult)
    * this button should be added on the left of the edit button for each task
    * clicking this button will add a random emoji to the end of the task
    * you don't need to touch html file and css is just for styling, so focus on js
    * good luck!

*/


var allowDuplicates = true;

window.addEventListener('load', () => {
    const form = document.querySelector("#new-task-form");
    const input = document.querySelector("#new-task-input");
    const delete_all = document.querySelector("#delete_all");
    const print_all = document.querySelector("#print_all");
    const draw_tasks = document.querySelector("#drawTasks_button");
    
    // array that stores all tasks in easily-accessible format, but that doesn't save upon page refresh
    let tasks = [];    

    // Each task has its own HTML element, this function handles creating each element with a forEach() loop. Function also refreshes all displayed tasks when called (refreshes task list)
    function drawTasks() {
        
        // refresh task array based on local storage
        try {
            tasks = [];
            JSON.parse(localStorage.tasks).forEach((task) => {
                tasks.push(task);
            }) 
        } catch (e) {
            console.log("caught error likely due to localStorage.tasks being empty. Is this an issue?")
            // HERE IS HOW TO TELL IF THERE ARE NO TASKS
        }
        
        // delete all drawn tasks (prevents dupplication of drawn tasks)
        try {
            document.querySelectorAll('.task').forEach((drawnTask) => {
                drawnTask.remove();
            })
        } catch (e) {
            console.log("Failed to delete drawn tasks.")
            console.log(e)
        }
        
        // draw each task
        try {
            tasks.forEach((task) => {
                const list_el = document.querySelector("#tasks");
                
                // creates tasks
                const task_el = document.createElement("div");
                task_el.classList.add("task");
                task_el.id = task.id;
        
                const task_content_el = document.createElement("div");
                task_content_el.classList.add("content");
        
                task_el.appendChild(task_content_el);
                
                const task_input_el = document.createElement("input");
                task_input_el.classList.add("text");
                task_input_el.type = "text";
                
                // determines the displayed text
                task_input_el.value = task.taskName;
                task_input_el.setAttribute("readonly", "readonly");
            
                task_content_el.appendChild(task_input_el);
        
                // creates buttons (required to display)
                const task_actions_el = document.createElement("div");
                task_actions_el.classList.add("actions");
        
                // creates emoji icon
                const task_emoji_el = document.createElement("button");
                task_emoji_el.classList.add("emoji");
                task_emoji_el.innerHTML = "Emoji";
        
                const task_emoji_icon = document.createElement("i");
                task_emoji_icon.innerHTML = '<i class="fa-solid fa-face-surprise"></i>';

                const task_edit_el = document.createElement("button");
                task_edit_el.classList.add("edit");
                task_edit_el.innerHTML = "Edit";
        
                const task_edit_icon = document.createElement("i");
                // creates the icon (this code is found at fontawesome.com)
                task_edit_icon.innerHTML = '<i class="fa-solid fa-pencil"></i>';

                const task_delete_icon = document.createElement("i");
                task_delete_icon.innerHTML = '<i class="fa-solid fa-trash""></i>';
                
                task_actions_el.appendChild(task_emoji_icon);
                task_actions_el.appendChild(task_edit_icon);
                task_actions_el.appendChild(task_delete_icon);
                
                task_el.appendChild(task_actions_el);
        
                list_el.appendChild(task_el);

                // edit button functionality
                task_edit_icon.addEventListener('click', () => {
                    task_input_el.removeAttribute("readonly");
                    task_input_el.focus();

                    document.addEventListener('keydown', function(event){
                        if(event.key === "Enter"){
                            task_input_el.setAttribute("readonly", "readonly")
                            
                            tasks[getIndexById(task_el.id)].taskName = task_input_el.value;
                            localStorage.setItem("tasks", JSON.stringify(tasks));

                            drawTasks();
                        }
                    });
                });

                // delete button functionality
                task_delete_icon.addEventListener('click', () => {
                        var tempLocalStorageDelete = JSON.parse(localStorage.getItem("tasks"));
                        
                        tempLocalStorageDelete.splice(getIndexById(task_el.id), 1);

                        localStorage.setItem("tasks", JSON.stringify(tempLocalStorageDelete))

                        drawTasks();
                    });

                // emoji button functionality
                task_emoji_icon.addEventListener('click', () => {
                    var tempTask = tasks[getIndexById(task_el.id)].taskName

                    if (/\p{Extended_Pictographic}/u.test(tempTask)) {
                        tasks[getIndexById(task_el.id)].taskName = tempTask.replaceAll(/\p{Extended_Pictographic}/ug, getRandomEmoji());
                    } else {
                        tasks[getIndexById(task_el.id)].taskName = tempTask + " " + getRandomEmoji();
                    }
                    
                    localStorage.setItem("tasks", JSON.stringify(tasks));
                    drawTasks();
                })
            });
    
        } catch (e) {
            console.log("failed to draw tasks, error:");
            console.log(e);
        }
    };
    
    function getRandomEmoji() {
        const emojis = [
            'ðŸ˜„','ðŸ˜ƒ','ðŸ˜€','ðŸ˜Š','ðŸ˜‰','ðŸ˜','ðŸ˜˜','ðŸ˜š','ðŸ˜—','ðŸ˜™','ðŸ˜œ','ðŸ˜','ðŸ˜›','ðŸ˜³','ðŸ˜','ðŸ˜”','ðŸ˜Œ','ðŸ˜’','ðŸ˜ž','ðŸ˜£','ðŸ˜¢','ðŸ˜‚','ðŸ˜­','ðŸ˜ª','ðŸ˜¥','ðŸ˜°','ðŸ˜…','ðŸ˜“','ðŸ˜©','ðŸ˜«','ðŸ˜¨','ðŸ˜±','ðŸ˜ ','ðŸ˜¡','ðŸ˜¤','ðŸ˜–','ðŸ˜†','ðŸ˜‹','ðŸ˜·','ðŸ˜Ž','ðŸ˜´','ðŸ˜µ','ðŸ˜²','ðŸ˜Ÿ','ðŸ˜¦','ðŸ˜§','ðŸ˜ˆ','ðŸ‘¿','ðŸ˜®','ðŸ˜¬','ðŸ˜','ðŸ˜•','ðŸ˜¯','ðŸ˜¶','ðŸ˜‡','ðŸ˜','ðŸ˜‘','ðŸ‘²','ðŸ‘³','ðŸ‘®','ðŸ‘·','ðŸ’‚','ðŸ‘¶','ðŸ‘¦','ðŸ‘§','ðŸ‘¨','ðŸ‘©','ðŸ‘´','ðŸ‘µ','ðŸ‘±','ðŸ‘¼','ðŸ‘¸','ðŸ˜º','ðŸ˜¸','ðŸ˜»','ðŸ˜½','ðŸ˜¼','ðŸ™€','ðŸ˜¿','ðŸ˜¹','ðŸ˜¾','ðŸ‘¹','ðŸ‘º','ðŸ™ˆ','ðŸ™‰','ðŸ™Š','ðŸ’€','ðŸ‘½','ðŸ’©','ðŸ”¥','âœ¨','ðŸŒŸ','ðŸ’«','ðŸ’¥','ðŸ’¢','ðŸ’¦','ðŸ’§','ðŸ’¤','ðŸ’¨','ðŸ‘‚','ðŸ‘€','ðŸ‘ƒ','ðŸ‘…','ðŸ‘„','ðŸ‘','ðŸ‘Ž','ðŸ‘Œ','ðŸ‘Š','âœŠ','âœŒ','ðŸ‘‹','âœ‹','ðŸ‘','ðŸ‘†','ðŸ‘‡','ðŸ‘‰','ðŸ‘ˆ','ðŸ™Œ','ðŸ™','â˜','ðŸ‘','ðŸ’ª','ðŸš¶','ðŸƒ','ðŸ’ƒ','ðŸ‘«','ðŸ‘ª','ðŸ‘¬','ðŸ‘­','ðŸ’','ðŸ’‘','ðŸ‘¯','ðŸ™†','ðŸ™…','ðŸ’','ðŸ™‹','ðŸ’†','ðŸ’‡','ðŸ’…','ðŸ‘°','ðŸ™Ž','ðŸ™','ðŸ™‡','ðŸŽ©','ðŸ‘‘','ðŸ‘’','ðŸ‘Ÿ','ðŸ‘ž','ðŸ‘¡','ðŸ‘ ','ðŸ‘¢','ðŸ‘•','ðŸ‘”','ðŸ‘š','ðŸ‘—','ðŸŽ½','ðŸ‘–','ðŸ‘˜','ðŸ‘™','ðŸ’¼','ðŸ‘œ','ðŸ‘','ðŸ‘›','ðŸ‘“','ðŸŽ€','ðŸŒ‚','ðŸ’„','ðŸ’›','ðŸ’™','ðŸ’œ','ðŸ’š','â¤','ðŸ’”','ðŸ’—','ðŸ’“','ðŸ’•','ðŸ’–','ðŸ’ž','ðŸ’˜','ðŸ’Œ','ðŸ’‹','ðŸ’','ðŸ’Ž','ðŸ‘¤','ðŸ‘¥','ðŸ’¬','ðŸ‘£','ðŸ’­','ðŸ¶','ðŸº','ðŸ±','ðŸ­','ðŸ¹','ðŸ°','ðŸ¸','ðŸ¯','ðŸ¨','ðŸ»','ðŸ·','ðŸ½','ðŸ®','ðŸ—','ðŸµ','ðŸ’','ðŸ´','ðŸ‘','ðŸ˜','ðŸ¼','ðŸ§','ðŸ¦','ðŸ¤','ðŸ¥','ðŸ£','ðŸ”','ðŸ','ðŸ¢','ðŸ›','ðŸ','ðŸœ','ðŸž','ðŸŒ','ðŸ™','ðŸš','ðŸ ','ðŸŸ','ðŸ¬','ðŸ³','ðŸ‹','ðŸ„','ðŸ','ðŸ€','ðŸƒ','ðŸ…','ðŸ‡','ðŸ‰','ðŸŽ','ðŸ','ðŸ“','ðŸ•','ðŸ–','ðŸ','ðŸ‚','ðŸ²','ðŸ¡','ðŸŠ','ðŸ«','ðŸª','ðŸ†','ðŸˆ','ðŸ©','ðŸ¾','ðŸ’','ðŸŒ¸','ðŸŒ·','ðŸ€','ðŸŒ¹','ðŸŒ»','ðŸŒº','ðŸ','ðŸƒ','ðŸ‚','ðŸŒ¿','ðŸŒ¾','ðŸ„','ðŸŒµ','ðŸŒ´','ðŸŒ²','ðŸŒ³','ðŸŒ°','ðŸŒ±','ðŸŒ¼','ðŸŒ','ðŸŒž','ðŸŒ','ðŸŒš','ðŸŒ‘','ðŸŒ’','ðŸŒ“','ðŸŒ”','ðŸŒ•','ðŸŒ–','ðŸŒ—','ðŸŒ˜','ðŸŒœ','ðŸŒ›','ðŸŒ™','ðŸŒ','ðŸŒŽ','ðŸŒ','ðŸŒ‹','ðŸŒŒ','ðŸŒ ','â­','â˜€','â›…','â˜','âš¡','â˜”','â„','â›„','ðŸŒ€','ðŸŒ','ðŸŒˆ','ðŸŒŠ','ðŸŽ','ðŸ’','ðŸŽŽ','ðŸŽ’','ðŸŽ“','ðŸŽ','ðŸŽ†','ðŸŽ‡','ðŸŽ','ðŸŽ‘','ðŸŽƒ','ðŸ‘»','ðŸŽ…','ðŸŽ„','ðŸŽ','ðŸŽ‹','ðŸŽ‰','ðŸŽŠ','ðŸŽˆ','ðŸŽŒ','ðŸ”®','ðŸŽ¥','ðŸ“·','ðŸ“¹','ðŸ“¼','ðŸ’¿','ðŸ“€','ðŸ’½','ðŸ’¾','ðŸ’»','ðŸ“±','â˜Ž','ðŸ“ž','ðŸ“Ÿ','ðŸ“ ','ðŸ“¡','ðŸ“º','ðŸ“»','ðŸ”Š','ðŸ”‰','ðŸ”ˆ','ðŸ”‡','ðŸ””','ðŸ”•','ðŸ“¢','ðŸ“£','â³','âŒ›','â°','âŒš','ðŸ”“','ðŸ”’','ðŸ”','ðŸ”','ðŸ”‘','ðŸ”Ž','ðŸ’¡','ðŸ”¦','ðŸ”†','ðŸ”…','ðŸ”Œ','ðŸ”‹','ðŸ”','ðŸ›','ðŸ›€','ðŸš¿','ðŸš½','ðŸ”§','ðŸ”©','ðŸ”¨','ðŸšª','ðŸš¬','ðŸ’£','ðŸ”«','ðŸ”ª','ðŸ’Š','ðŸ’‰','ðŸ’°','ðŸ’´','ðŸ’µ','ðŸ’·','ðŸ’¶','ðŸ’³','ðŸ’¸','ðŸ“²','ðŸ“§','ðŸ“¥','ðŸ“¤','âœ‰','ðŸ“©','ðŸ“¨','ðŸ“¯','ðŸ“«','ðŸ“ª','ðŸ“¬','ðŸ“­','ðŸ“®','ðŸ“¦','ðŸ“','ðŸ“„','ðŸ“ƒ','ðŸ“‘','ðŸ“Š','ðŸ“ˆ','ðŸ“‰','ðŸ“œ','ðŸ“‹','ðŸ“…','ðŸ“†','ðŸ“‡','ðŸ“','ðŸ“‚','âœ‚','ðŸ“Œ','ðŸ“Ž','âœ’','âœ','ðŸ“','ðŸ“','ðŸ“•','ðŸ“—','ðŸ“˜','ðŸ“™','ðŸ““','ðŸ“”','ðŸ“’','ðŸ“š','ðŸ“–','ðŸ”–','ðŸ“›','ðŸ”¬','ðŸ”­','ðŸ“°','ðŸŽ¨','ðŸŽ¬','ðŸŽ¤','ðŸŽ§','ðŸŽ¼','ðŸŽµ','ðŸŽ¶','ðŸŽ¹','ðŸŽ»','ðŸŽº','ðŸŽ·','ðŸŽ¸','ðŸ‘¾','ðŸŽ®','ðŸƒ','ðŸŽ´','ðŸ€„','ðŸŽ²','ðŸŽ¯','ðŸˆ','ðŸ€','âš½','âš¾','ðŸŽ¾','ðŸŽ±','ðŸ‰','ðŸŽ³','â›³','ðŸšµ','ðŸš´','ðŸ','ðŸ‡','ðŸ†','ðŸŽ¿','ðŸ‚','ðŸŠ','ðŸ„','ðŸŽ£','â˜•','ðŸµ','ðŸ¶','ðŸ¼','ðŸº','ðŸ»','ðŸ¸','ðŸ¹','ðŸ·','ðŸ´','ðŸ•','ðŸ”','ðŸŸ','ðŸ—','ðŸ–','ðŸ','ðŸ›','ðŸ¤','ðŸ±','ðŸ£','ðŸ¥','ðŸ™','ðŸ˜','ðŸš','ðŸœ','ðŸ²','ðŸ¢','ðŸ¡','ðŸ³','ðŸž','ðŸ©','ðŸ®','ðŸ¦','ðŸ¨','ðŸ§','ðŸŽ‚','ðŸ°','ðŸª','ðŸ«','ðŸ¬','ðŸ­','ðŸ¯','ðŸŽ','ðŸ','ðŸŠ','ðŸ‹','ðŸ’','ðŸ‡','ðŸ‰','ðŸ“','ðŸ‘','ðŸˆ','ðŸŒ','ðŸ','ðŸ','ðŸ ','ðŸ†','ðŸ…','ðŸŒ½','ðŸ ','ðŸ¡','ðŸ«','ðŸ¢','ðŸ£','ðŸ¥','ðŸ¦','ðŸª','ðŸ©','ðŸ¨','ðŸ’’','â›ª','ðŸ¬','ðŸ¤','ðŸŒ‡','ðŸŒ†','ðŸ¯','ðŸ°','â›º','ðŸ­','ðŸ—¼','ðŸ—¾','ðŸ—»','ðŸŒ„','ðŸŒ…','ðŸŒƒ','ðŸ—½','ðŸŒ‰','ðŸŽ ','ðŸŽ¡','â›²','ðŸŽ¢','ðŸš¢','â›µ','ðŸš¤','ðŸš£','âš“','ðŸš€','âœˆ','ðŸ’º','ðŸš','ðŸš‚','ðŸšŠ','ðŸš‰','ðŸšž','ðŸš†','ðŸš„','ðŸš…','ðŸšˆ','ðŸš‡','ðŸš','ðŸš‹','ðŸšƒ','ðŸšŽ','ðŸšŒ','ðŸš','ðŸš™','ðŸš˜','ðŸš—','ðŸš•','ðŸš–','ðŸš›','ðŸšš','ðŸš¨','ðŸš“','ðŸš”','ðŸš’','ðŸš‘','ðŸš','ðŸš²','ðŸš¡','ðŸšŸ','ðŸš ','ðŸšœ','ðŸ’ˆ','ðŸš','ðŸŽ«','ðŸš¦','ðŸš¥','âš ','ðŸš§','ðŸ”°','â›½','ðŸ®','ðŸŽ°','â™¨','ðŸ—¿','ðŸŽª','ðŸŽ­','ðŸ“','ðŸš©','â¬†','â¬‡','â¬…','âž¡','ðŸ” ','ðŸ”¡','ðŸ”¤','â†—','â†–','â†˜','â†™','â†”','â†•','ðŸ”„','â—€','â–¶','ðŸ”¼','ðŸ”½','â†©','â†ª','â„¹','âª','â©','â«','â¬','â¤µ','â¤´','ðŸ†—','ðŸ”€','ðŸ”','ðŸ”‚','ðŸ†•','ðŸ†™','ðŸ†’','ðŸ†“','ðŸ†–','ðŸ“¶','ðŸŽ¦','ðŸˆ','ðŸˆ¯','ðŸˆ³','ðŸˆµ','ðŸˆ´','ðŸˆ²','ðŸ‰','ðŸˆ¹','ðŸˆº','ðŸˆ¶','ðŸˆš','ðŸš»','ðŸš¹','ðŸšº','ðŸš¼','ðŸš¾','ðŸš°','ðŸš®','ðŸ…¿','â™¿','ðŸš­','ðŸˆ·','ðŸˆ¸','ðŸˆ‚','â“‚','ðŸ›‚','ðŸ›„','ðŸ›…','ðŸ›ƒ','ðŸ‰‘','ãŠ™','ãŠ—','ðŸ†‘','ðŸ†˜','ðŸ†”','ðŸš«','ðŸ”ž','ðŸ“µ','ðŸš¯','ðŸš±','ðŸš³','ðŸš·','ðŸš¸','â›”','âœ³','â‡','âŽ','âœ…','âœ´','ðŸ’Ÿ','ðŸ†š','ðŸ“³','ðŸ“´','ðŸ…°','ðŸ…±','ðŸ†Ž','ðŸ…¾','ðŸ’ ','âž¿','â™»','â™ˆ','â™‰','â™Š','â™‹','â™Œ','â™','â™Ž','â™','â™','â™‘','â™’','â™“','â›Ž','ðŸ”¯','ðŸ§','ðŸ’¹','ðŸ’²','ðŸ’±','Â©','Â®','â„¢','ã€½','ã€°','ðŸ”','ðŸ”š','ðŸ”™','ðŸ”›','ðŸ”œ','âŒ','â­•','â—','â“','â•','â”','ðŸ”ƒ','ðŸ•›','ðŸ•§','ðŸ•','ðŸ•œ','ðŸ•‘','ðŸ•','ðŸ•’','ðŸ•ž','ðŸ•“','ðŸ•Ÿ','ðŸ•”','ðŸ• ','ðŸ••','ðŸ•–','ðŸ•—','ðŸ•˜','ðŸ•™','ðŸ•š','ðŸ•¡','ðŸ•¢','ðŸ•£','ðŸ•¤','ðŸ•¥','ðŸ•¦','âœ–','âž•','âž–','âž—','â™ ','â™¥','â™£','â™¦','ðŸ’®','ðŸ’¯','âœ”','â˜‘','ðŸ”˜','ðŸ”—','âž°','ðŸ”±','ðŸ”²','ðŸ”³','â—¼','â—»','â—¾','â—½','â–ª','â–«','ðŸ”º','â¬œ','â¬›','âš«','âšª','ðŸ”´','ðŸ”µ','ðŸ”»','ðŸ”¶','ðŸ”·','ðŸ”¸','ðŸ”¹'
        ];

        return emojis[Math.floor(Math.random() * emojis.length)];
    };


    // drawTasks when page is first loaded
    drawTasks();

    // adding tasks
    form.addEventListener('submit', (e) => {
        e.preventDefault();
        
        // prevent duplicates (if enabled)
        var tempDupToggle;
        tasks.forEach((task) => {
            if (task.taskName == input.value && !allowDuplicates) {
                alert("duplicate task entered!")
                input.value = "";
                tempDupToggle = true;
                return;
            }
        })
        
        // prevent blank tasks
        if (!input.value) {
            if (tempDupToggle) {
                tempDupToggle = !tempDupToggle;
                return;
            }
            alert("no text entered");
            return;
        }

        // create task object
        const taskObj = {
            taskName:input.value, 
            status:"TEMP", 
            id: Math.floor(Date.now() + Math.random()),
            priority: "TEMP"
        }

       // append individual task to tasks array, then update localStorage to match
        tasks.push(taskObj);
        localStorage.setItem("tasks", JSON.stringify(tasks));
        
        // clear input field
        input.value = "";

        // refresh tasks by calling drawTask function so that new task is displayed
        drawTasks();

    });
    
    // delete_all functionality
    delete_all.addEventListener('click', () => {
        console.log("Local storage cleared.");
        localStorage.clear();
        drawTasks();
    });
    
    // print all functionality
    print_all.addEventListener('click', () => {
        try {
            console.log("session tasks array:")
            console.log(tasks)
            console.log("local storage:")
            console.log(JSON.parse(localStorage.tasks))
            console.log("========")
        } catch (e) {
            console.log("No tasks in local storage.")
        }
    });

    // drawTasks dev button functionality
    draw_tasks.addEventListener('click', () => {
        drawTasks();
    });

});

// temp settings popup functionality
function toggleSettings() {
    document.getElementById("settings_popup").classList.toggle("active");
}

// allow user to use escape to toggle settings (note that this should be updated as it's currently constantly checking for escape, it should only check when the settings is opened)
document.addEventListener('keydown', function(event){
	if(event.key === "Escape"){
        document.getElementById("settings_popup").classList.toggle("active");
	}
});

function toggleDuplicates() {
    console.log("user wants to toggle duplicates!")
    allowDuplicates = !allowDuplicates;
    console.log(allowDuplicates)
}

// my saving-grace function that I somehow was able to figure out at 3:30 AM
function getIndexById(Id) {
    var tempLocalStorage = JSON.parse(localStorage.getItem("tasks"))
    var target;

    for (var i = 0; i < tempLocalStorage.length; i++) {
        var item = tempLocalStorage[i];
        if (item.id == Id) {
            target = i;
        }
    }
    return target;
}


// gpt-j fetch request for joke button
function testAPI() {
    fetch("https://api.ai21.com/studio/v1/j1-jumbo/complete", {
      headers: {
        "Authorization": "Bearer X9U5ZKe7tI7oe5ni0zPLyIUo3w19xJCS",
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
          "prompt": "Joke: ",
          "numResults": 1,
          "maxTokens": 64,
          "temperature": 0.7,
          "topKReturn": 0,
          "topP":1,
          "countPenalty": {
            "scale": 0,
            "applyToNumbers": false,
            "applyToPunctuations": false,
            "applyToStopwords": false,
            "applyToWhitespaces": false,
            "applyToEmojis": false
          },
          "frequencyPenalty": {
            "scale": 0,
            "applyToNumbers": false,
            "applyToPunctuations": false,
            "applyToStopwords": false,
            "applyToWhitespaces": false,
            "applyToEmojis": false
          },
          "presencePenalty": {
            "scale": 0,
            "applyToNumbers": false,
            "applyToPunctuations": false,
            "applyToStopwords": false,
            "applyToWhitespaces": false,
            "applyToEmojis": false
          },
          "stopSequences":["\n"]
        }),
      method: "POST"
    }).then(response => response.json()).then(data => {
        alert(data.completions[0].data.text)
    });
}